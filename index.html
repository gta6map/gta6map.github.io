<!DOCTYPE html>
    <html lang="en">
    <head>
        <title>GTA VI Landmarks Map</title>
        <meta charset="utf-8"/>
        <link rel="icon" href="gta6map.png"/>
        <style>
            html, body {
                background: rgb(0, 0, 0);
                font-family: sans-serif;
                font-size: 11px;
                height: 100%;
                margin: 0;
                overflow: hidden;
                padding: 0;
                width: 100%;
            }
            a {
                color: rgb(0, 0, 0);
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
            }
            input[type="text"] {
                all: unset;
                appearance: none;
                -moz-appearance: none;
                -ms-appearance: none;
                -webkit-appearance: none;
                background-color: transparent;
                border: 1px solid transparent;
                box-sizing: border-box;
                font-family: sans-serif;
                font-size: 12px;
                height: 18px;
                margin: 0;
                padding: 2px 4px;
                position: absolute;
            }
            input[type="text"]:focus {
                border: 1px solid rgb(192, 192, 192);
                outline: none;
            }
            input[type="text"]::placeholder {
                color: rgb(128, 128, 128)
            }
            select {
                all: unset;
                appearance: none;
                -moz-appearance: none;
                -ms-appearance: none;
                -webkit-appearance: none;
                background: transparent;
                background-image: none;
                border: 1px solid transparent;
                border-radius: 4px;
                box-sizing: border-box;
                color: inherit;
                cursor: pointer;
                font: inherit;
                font-family: sans-serif;
                font-size: 12px;
                margin: 0;
                padding: 2px 4px;
            }
            select:focus {
                outline: none;
            }
            select::-ms-expand {
                display: none
            }
            span.unknown {
                color: rgb(255, 0, 0);
            }
            #map, #canvas, #markers {
                bottom: 0;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
            }
            #map {
                cursor: default;
                inset: 0;
            }
            #map.dragging {
                cursor: grabbing;
            }
            #canvas {
                filter: saturate(0.2);
                user-select: none;
            }
            .marker {
                background-color: rgb(192, 192, 192);
                border: 1px solid rgb(0, 0, 0);
                border-radius: 8px 8px 0 8px;
                cursor: pointer;
                display: none;
                height: 14px;
                left: 50%;
                margin-left: -8px;
                margin-top: -19.314px;
                position: absolute;
                top: 50%;
                transform: rotate(45deg);
                width: 14px;
                z-index: 100;
            }
            .marker.selected {
                border: 2px solid rgb(255, 255, 255);
                height: 12px;
                width: 12px;
                z-index: 101;
            }
            .marker.dragging {
                border: 2px solid rgb(128, 128,128);
            }
            .marker.agriculture {
                background-color: rgb(192, 192, 0);
            }
            .marker.commercial {
                background-color: rgb(0, 0, 255);
            }
            .marker.entertainment {
                background-color: rgb(255, 128, 0);
            }
            .marker.government {
                background-color: rgb(255, 0, 0);
            }
            .marker.hotel {
                background-color: rgb(0, 255, 255);
            }
            .marker.infrastructure {
                background-color: rgb(128, 128, 128);
            }
            .marker.industrial {
                background-color: rgb(255, 255, 0);
            }
            .marker.monument {
                background-color: rgb(128, 0, 0);
            }
            .marker.other {
                background-color: rgb(240, 240, 240);
            }
            .marker.public {
                background-color: rgb(255, 0, 255);
            }
            .marker.nature {
                background-color: rgb(0, 128, 0);
            }
            .marker.residential {
                background-color: rgb(0, 255, 0);
            }
            .marker.transport {
                background-color: rgb(192, 192, 192);
            }
            .panel {
                background-color: rgba(255, 255, 255, 0.75);
                bottom: 0;
                position: absolute;
                top: 0;
                width: 256px;
                z-index: 1000;
            }
            #listPanel {
                left: 0;
            }
            #findBar {
                border-bottom: 1px solid rgb(192, 192, 192);
                height: 31px;
                left: 0;
                position: absolute;
                top: 0;
                width: 256px
            }
            #findBar input {
                left: 8px;
                position: absolute;
                top: 7px;
                width: 192px;
            }
            #filterBar {
                border-bottom: 1px solid rgb(192, 192, 192);
                height: 31px;
                left: 0;
                position: absolute;
                top: 32px;
                width: 256px
            }
            #filterBar select {
                width: 192px
            }
            .clearButton, .closeButton {
                cursor: pointer;
                font-size: 11px;
                height: 12px;
                position: absolute;
                right: 8px;
                top: 9px;
                user-select: none;
            }
            .clearButton {
                display: none;
            }
            #sortBar {
                border-bottom: 1px solid rgb(192, 192, 192);
                height: 31px;
                left: 0;
                position: absolute;
                top: 64px;
                width: 256px
            }
            #filterBar select, #sortBar select {
                left: 8px;
                position: absolute;
                top: 6px;
            }
            #listBody {
                bottom: 32px;
                left: 0;
                overflow-y: scroll;
                position: absolute;
                top: 96px;
                width: 256px;
            }
            #listBody > .item {
                border-left: 8px solid transparent;
                cursor: pointer;
                height: 32px;
                width: 248px;
            }
            #listBody > .item.selected {
                background-color: rgb(255, 255, 255);
            }
            #listBody > .item div {
                overflow-x: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #listBody > .item .ig {
                font-size: 11px;
                font-weight: bold;
                height: 13px;
                left: 8px;
                padding: 4px 8px 1px 8px;
                top: 0;
                width: 232px;
            }
            #listBody > .item .irl {
                bottom: 0;
                font-size: 9px;
                height: 11px;
                left: 8px;
                padding: 1px 8px 2px 8px;
                width: 232px;
            }
            #statusBar {
                border-top: 1px solid rgb(192, 192, 192);
                bottom: 0;
                height: 12px;
                left: 0;
                padding: 10px 8px;
                position: absolute;
                width: 240px;
            }
            #itemPanel {
                display: none;
                font-size: 13px;
                right: 0
            }
            #itemBar {
                border-bottom: 1px solid rgb(192, 192, 192);
                height: 31px;
                right: 0;
                position: absolute;
                top: 0;
                width: 256px
            }
            #itemId {
                font-size: 13px;
                left: 10px;
                position: absolute;
                top: 8px;
            }
            #itemBody {
                bottom: 0;
                left: 0;
                overflow-y: scroll;
                position: absolute;
                top: 32px;
                width: 256px;
            }
            #itemBody > div {
                float: left;
                height: fit-content;
                width: 232px;
            }
            #itemIg, #itemIrl {
                border-right: 8px solid transparent;
                height: fit-content;
                padding: 8px;
            }
            #itemBody > div.photo {
                background-color: rgba(0, 0, 0, 0.25);
                height: 144px;
                width: 256px;
            }
            #itemBody > div.photo > img {
                cursor: pointer;
            }
            #itemBody > div > div {
                float: left;
                margin: 2px 2px;
                width: 200px;
            }
            #itemBody > div > div.name {
                font-size: 15px;
                font-weight: bold;
                margin-top: 0;
            }
            #itemBody > div > div.coordinates {
                font-size: 11px;
                margin-bottom: 0;
            }
            #itemEdited {
                float: left;
                font-size: 11px;
                padding: 8px;
            }
            #dialogLayer {
                align-items: center;
                background-color: rgba(0, 0, 0, 0.25);
                bottom: 0;
                display: none;
                justify-content: center;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
                z-index: 1001;
            }
            #photoDialog {
                height: 608px;
                width: 1024px;
            }
            #photoDialog .bar {
                background-color: rgba(255, 255, 255, 0.75);
                border-radius: 8px 8px 0 0;
                height: 32px;
                width: 1024px;
            }
            #photoDialog .bar .title {
                float: left;
                font-size: 13px;
                font-weight: bold;
                height: 16px;
                margin: 8px 8px;
                right: 0;
                overflow-x: hidden;
                top: 0;
                width: 944px;
            }
            #photoDialog .bar .button {
                cursor: pointer;
                float: left;
                font-size: 11px;
                height: 12px;
                margin: 10px 0;
                right: 0;
                text-align: center;
                top: 0;
                width: 64px;
                user-select: none;
            }
            #photoDialog .content {
                height: 576px;
                width: 1024px;
            }
            #photoDialog .content img {
                border-radius: 0 0 8px 8px;
                height: 576px;
                user-select: none;
                width: 1024px;
            }
        </style>
    </head>
    <body>
        <script>

function Map() {

    let that = this
    let self = {
        mapW: 32768,
        mapH: 32768,
        minX: -16000,
        maxX: 4000,
        minY: -8000,
        maxY: 12000,
        minZ: 1,
        maxZ: 6,
        zeroX: 22384,
        zeroY: 18384,
        tileSize: 1024,
        tileRanges: {
            1: [[ 0,  0], [ 1,  1]],
            2: [[ 0,  0], [ 3,  3]],
            3: [[ 1,  1], [ 6,  6]],
            4: [[ 3,  3], [12, 12]],
            5: [[ 6,  6], [25, 25]],
            6: [[12, 12], [51, 51]]
        },
        tiles: {},
        defaultX: -4000,
        defaultY: 2000,
        defaultZ: 1,
        x: null,
        y: null,
        z: null,
        l: null,
        targetX: 0,
        targetY: 0,
        isAnimating: false,
        isDragging: false,
        key: null,
        panAmount: 0.025,
        wheelAmount: 0.005,
        zoomAmount: 0.025,
        easeAmount: 0.2,
        landmarks: [],
        landmarksById: {},
        currentLandmarks: [],
        landmarkTypes: [
            "agriculture",
            "commercial",
            "entertainment",
            "government",
            "hotel",
            "industry",
            "monument",
            "public",
            "natural",
            "residential",
            "transportation"
        ],
        query: "",
        landmarksFilter: "all",
        landmarksFilterOptions: {
            "all": "all",
            "identified": "identified",
            "unconfirmed": "unconfirmed",
            "unidentified": "unidentified",
            "knownName": "known name",
            "unknownName": "unknown name",
            "missingLatLng": "missing latlng",
            "included": "on the map",
            "notIncluded": "not on the map"
        },
        landmarksSort: "igAddress",
        landmarksSortOptions: {
            igAddress: "in-game address",
            igLatitude: "in-game latitude",
            igLongitude: "in-game longitude",
            irlAddress: "real-life address",
            irlLatitude: "real-life latitude",
            irlLongitude: "real-life longitude",
            type: "type",
            edited: "last edited"
        },
        markers: {},
        focus: "map"
    }

    self.init = function() {

        self.element = document.createElement("div")
        self.element.id = "map"
        self.canvas = document.createElement("canvas")
        self.canvas.id = "canvas"
        self.element.appendChild(self.canvas)
        self.context = self.canvas.getContext("2d")
        self.markersLayer = document.createElement("div")
        self.markersLayer.id = "markers"
        self.element.appendChild(self.markersLayer)
        document.body.appendChild(self.element)

        const zInt = Math.ceil(self.z)
        for (let z = self.minZ; z <= self.maxZ; z++) {
            self.tiles[z] = []
            const [[x0, y0], [x1, y1]] = self.tileRanges[z]
            for (let y = y0; y <= y1; y++) {
                self.tiles[z][y] = []
                for (let x = x0; x <= x1; x++) {
                    self.tiles[z][y][x] = new Image()
                    if (z == zInt) {
                        self.tiles[z][y][x].onload = self.render
                        self.tiles[z][y][x].src = `tiles/${z}/${z},${y},${x}.png`
                    }
                }
            }
        }

        self.markersLayer.addEventListener("click", self.onClick)
        window.addEventListener("hashchange", self.onHashchange)
        document.addEventListener("keydown", self.onKeydown)
        document.addEventListener("keyup", self.onKeyup)
        self.markersLayer.addEventListener('mousedown',self.onMousedown)
        window.addEventListener("resize", self.onResize)
        self.markersLayer.addEventListener("wheel", self.onWheel, {passive: false})

        self.onResize(false)
        self.onHashchange()

        self.loadJSON("data/landmarks.json").then(function(data) {
            self.landmarks = data.map(function(item) {
                return {
                    "id": item[0],
                    "igAddress": item[1],
                    "igAddressLower": item[1].toLowerCase(),
                    "igCoordinates": item[2],
                    "irlAddress": item[3],
                    "irlAddressLower": item[3].toLowerCase(),
                    "irlCoordinates": item[4],
                    "type": item[5] || "other",
                    "color": item[6],
                    "edited": item[7]
                }
            }).filter(function(item) {
                return item["igCoordinates"][0] != 0 || item["igCoordinates"][1] != 0
            })
            self.landmarks.forEach(function(landmark) {
                landmark.igNameAndAddress = self.getLandmarkNameAndAddress(landmark.igAddress)
                landmark.irlNameAndAddress = self.getLandmarkNameAndAddress(landmark.irlAddress)
                landmark.title = self.getLandmarkTitle(landmark)
            })
            self.landmarksById = self.landmarks.reduce(function(a, v) {
                a[v.id] = v
                return a
            }, {})
            self.currentLandmarks = self.landmarks.slice()

            self.markers = {}
            self.landmarks.sort(function(a, b) {
                return b.igCoordinates[1] - a.igCoordinates[1]
            }).forEach(function(landmark) {
                self.markers[landmark.id] = document.createElement("div")
                self.markers[landmark.id].id = "marker_" + landmark.id
                // self.markers[landmark.id].classList.add("marker", landmark.type)
                self.markers[landmark.id].className = "marker"
                self.markers[landmark.id].style.backgroundColor = "#" + landmark.color 
                self.markers[landmark.id].title = landmark.title
                self.markersLayer.appendChild(self.markers[landmark.id])
            })
            self.sortLandmarks(self.landmarksSort)

            self.listPanel = document.createElement("div")
            self.listPanel.className = "panel"
            self.listPanel.id = "listPanel"
            self.element.appendChild(self.listPanel)

            self.findBar = document.createElement("div")
            self.findBar.id = "findBar"
            self.listPanel.appendChild(self.findBar)

            self.findElement = document.createElement("input")
            self.findElement.type = "text"
            self.findElement.placeholder = "FIND"
            self.findElement.spellcheck = false
            self.findElement.addEventListener("change", function(e) {
                self.findElement.blur()
                setTimeout(function() {
                    // allow for clear button
                    self.findAndFilterLandmarks(self.findElement.value, self.landmarksFilter)
                })
            })
            self.findElement.addEventListener("input", function(e) {
                self.clearFindButton.style.display = self.findElement.value ? "block" : "none"
            })
            self.findBar.appendChild(self.findElement)

            self.clearFindButton = document.createElement("div")
            self.clearFindButton.className = "clearButton"
            self.clearFindButton.innerHTML = "CLEAR"
            self.clearFindButton.addEventListener("mousedown", function() {
                self.findElement.value = ""
                self.findAndFilterLandmarks("", self.landmarksFilter)
                self.clearFindButton.style.display = "none"
            })
            self.findBar.appendChild(self.clearFindButton)

            self.filterBar = document.createElement("div")
            self.filterBar.id = "filterBar"
            self.listPanel.appendChild(self.filterBar)

            self.filterElement = document.createElement("select")
            Object.entries(self.landmarksFilterOptions).forEach(function([key, value]) {
                const element = document.createElement("option")
                element.value = key
                element.textContent = ("Filter: " + value).toUpperCase()
                element.selected = key == self.landmarksFilter
                self.filterElement.appendChild(element)
            })
            self.filterElement.addEventListener("change", function(e) {
                this.blur()
                self.clearFilterButton.style.display = self.filterElement.value != "all" ? "block" : "none"
                self.findAndFilterLandmarks(self.query, this.value)
                self.renderList()
            })
            self.filterBar.appendChild(self.filterElement)

            self.clearFilterButton = document.createElement("div")
            self.clearFilterButton.className = "clearButton"
            self.clearFilterButton.innerHTML = "CLEAR"
            self.clearFilterButton.addEventListener("mousedown", function() {
                self.filterElement.value = "all"
                self.findAndFilterLandmarks(self.query, "all")
                self.clearFilterButton.style.display = "none"
            })
            self.filterBar.appendChild(self.clearFilterButton)

            self.sortBar = document.createElement("div")
            self.sortBar.id = "sortBar"
            self.sortBar.addEventListener("click", function(e) {
                if (e.target == self.sortBar) {
                    self.listBody.scrollTo(0, 0)
                }
            })
            self.listPanel.appendChild(self.sortBar)

            self.sortElement = document.createElement("select")
            Object.entries(self.landmarksSortOptions).forEach(function([key, value]) {
                const element = document.createElement("option")
                element.value = key
                element.textContent = ("Sort by " + value).toUpperCase()
                element.selected = key == self.landmarksSort
                self.sortElement.appendChild(element)
            })
            self.sortElement.addEventListener("change", function(e) {
                this.blur()
                self.sortLandmarks(this.value)
                self.renderList()
                if (self.l) {
                    self.selectLandmark(self.l)
                }
            })
            self.sortBar.appendChild(self.sortElement)

            self.listBody = document.createElement("div")
            self.listBody.id = "listBody"
            self.listPanel.appendChild(self.listBody)

            self.statusBar = document.createElement("div")
            self.statusBar.id = "statusBar"
            self.statusBar.addEventListener("click", function(e) {
                if (e.target == self.statusBar) {
                    self.listBody.scrollTo(0, self.landmarks.length * 32)
                }
            })
            self.renderStatus()
            self.listPanel.appendChild(self.statusBar)

            self.renderList()

            self.itemPanel = document.createElement("div")
            self.itemPanel.className = "panel"
            self.itemPanel.id = "itemPanel"
            self.element.appendChild(self.itemPanel)

            self.itemBar = document.createElement("div")
            self.itemBar.id = "itemBar"
            self.itemPanel.appendChild(self.itemBar)

            self.itemId = document.createElement("div")
            self.itemId.id = "itemId"
            self.itemBar.appendChild(self.itemId)

            self.closeItemButton = document.createElement("div")
            self.closeItemButton.className = "closeButton"
            self.closeItemButton.innerHTML = "CLOSE"
            self.closeItemButton.addEventListener("mousedown", function() {
                self.selectLandmark(null)
            })
            self.itemBar.appendChild(self.closeItemButton)

            self.itemBody = document.createElement("div")
            self.itemBody.id = "itemBody"
            self.itemPanel.appendChild(self.itemBody)

            self.itemIg = document.createElement("div")
            self.itemIg.id = "itemIg"
            self.itemBody.appendChild(self.itemIg)

            self.itemIgName = document.createElement("div")
            self.itemIgName.className = "name"
            self.itemIg.appendChild(self.itemIgName)

            self.itemIgAddress = document.createElement("div")
            self.itemIg.appendChild(self.itemIgAddress)

            self.itemIgCoordinates = document.createElement("div")
            self.itemIgCoordinates.className = "coordinates"
            self.itemIg.appendChild(self.itemIgCoordinates)

            self.itemIgPhoto = document.createElement("div")
            self.itemIgPhoto.className = "photo"
            self.itemBody.appendChild(self.itemIgPhoto)

            self.itemIrl = document.createElement("div")
            self.itemIrl.id = "itemIrl"
            self.itemBody.appendChild(self.itemIrl)

            self.itemIrlName = document.createElement("div")
            self.itemIrlName.className = "name"
            self.itemIrl.appendChild(self.itemIrlName)

            self.itemIrlAddress = document.createElement("div")
            self.itemIrl.appendChild(self.itemIrlAddress)

            self.itemIrlCoordinates = document.createElement("div")
            self.itemIrlCoordinates.className = "coordinates"
            self.itemIrl.appendChild(self.itemIrlCoordinates)

            self.itemIrlPhoto = document.createElement("div")
            self.itemIrlPhoto.className = "photo"
            self.itemBody.appendChild(self.itemIrlPhoto)

            self.itemEdited = document.createElement("div")
            self.itemEdited.id = "itemEdited"
            self.itemBody.appendChild(self.itemEdited)

            self.dialogLayer = document.createElement("div")
            self.dialogLayer.id = "dialogLayer"
            self.element.appendChild(self.dialogLayer)

            self.photoDialog = document.createElement("div")
            self.photoDialog.id = "photoDialog"
            self.dialogLayer.appendChild(self.photoDialog)

            self.photoDialogBar = document.createElement("div")
            self.photoDialogBar.className = "bar"
            self.photoDialog.appendChild(self.photoDialogBar)

            self.photoDialogTitle = document.createElement("div")
            self.photoDialogTitle.className = "title"
            self.photoDialogBar.appendChild(self.photoDialogTitle)

            self.photoDialogButton = document.createElement("div")
            self.photoDialogButton.className = "button"
            self.photoDialogButton.innerHTML = "CLOSE"
            self.photoDialogButton.addEventListener("click", function(e) {
                self.closePhotoDialog()
            })
            self.photoDialogBar.appendChild(self.photoDialogButton)

            self.photoDialogContent = document.createElement("div")
            self.photoDialogContent.className = "content"
            self.photoDialog.appendChild(self.photoDialogContent)

            document.addEventListener("keydown", function(e) {
                const activeElement = document.activeElement
                if (activeElement.tagName == "INPUT") {
                    return
                }
                if (self.focus != "list") {
                    return
                }
                if (["ArrowDown", "ArrowUp"].includes(e.key)) {
                    e.preventDefault()
                }
                if (self.l === null) {
                    return
                }
                if (e.key == "ArrowDown") {
                    const index = self.currentLandmarkIndexById[self.l]
                    if (index < self.currentLandmarks.length - 1) {
                        self.selectLandmark(self.currentLandmarks[index + 1].id)
                        self.panToLandmark()
                    }
                } else if (e.key == "ArrowLeft") {
                    const index = self.currentLandmarkIndexById[self.l]
                    if (index > 0) {
                        self.selectLandmark(self.currentLandmarks[0].id)
                        self.panToLandmark()
                    }
                } else if (e.key == "ArrowRight") {
                    const index = self.currentLandmarkIndexById[self.l]
                    if (index < self.currentLandmarks.length - 1) {
                        self.selectLandmark(self.currentLandmarks[self.currentLandmarks.length - 1].id)
                        self.panToLandmark()
                    }
                } else if (e.key == "ArrowUp") {
                    const index = self.currentLandmarkIndexById[self.l]
                    if (index > 0) {
                        self.selectLandmark(self.currentLandmarks[index - 1].id)
                        self.panToLandmark()
                    }
                } else if (e.key == "Escape") {
                    if (self.l) {
                        self.selectLandmark(null)
                    }
                }
            })
            self.listPanel.addEventListener("mousedown", function(e) {
                self.focus = "list"
                if (e.target.parentElement.classList.contains("item")) {
                    const id = e.target.parentElement.id.replace("item_", "")
                    if (e.metaKey && e.target.parentElement.classList.contains("selected")) {
                        self.selectLandmark(null)
                    } else {
                        self.selectLandmark(id)
                        self.panToLandmark()
                    }
                }
            })

        }).catch(function(err) {
            console.log("ERROR", err) // FIXME
        })

        return that

    }

    self.animate = function(immediate=false) {
        //console.log("animate", immediate)
        if (!immediate) {
            self.isAnimating = true
        }
        const dx = self.hashX - self.x
        const dy = self.hashY - self.y
        const dz = self.hashZ - self.z
        if (!immediate && Math.abs(dx) < 0.001 && Math.abs(dy) < 0.001 && Math.abs(dz) <= 0.001) {
            self.x = self.hashX
            self.y = self.hashY
            self.z = self.hashZ
            //console.log("STOP ANIMATION", "immediate", immediate, "dx", dx, "dy", dy, "dz", dz)
            self.isAnimating = false
            self.setHashURL()
            return
        }
        //console.log("immediate", immediate, "dx", dx, "dy", dy, "dz", dz)
        easeAmount = immediate ? 1 : self.easeAmount
        self.x += easeAmount * dx
        self.y += easeAmount * dy
        self.z += easeAmount * dz
        self.renderMap()
        if (!immediate) {
            requestAnimationFrame(function() {self.animate()})
        }
    }

    self.clamp = function(n, min, max) {
        return Math.min(Math.max(n, min), max)
    }

    self.findAndFilterLandmarks = function(query, filter) {
        self.query = query.toLowerCase()
        self.landmarksFilter = filter
        self.currentLandmarks = self.landmarks.filter(function(landmark) {
            return (
                landmark.igAddressLower.includes(self.query) ||
                landmark.irlAddressLower.includes(self.query)
            ) && (
                self.landmarksFilter == "all" ||
                self.landmarksFilter == "identified" && landmark.irlAddress[0] != "?" ||
                self.landmarksFilter == "unconfirmed" && landmark.irlAddress.endsWith(" (?)") ||
                self.landmarksFilter == "unidentified" && landmark.irlAddress[0] == "?" ||
                self.landmarksFilter == "knownName" && landmark.igAddress[0] != "?" ||
                self.landmarksFilter == "unknownName" && landmark.igAddress[0] == "?" ||
                self.landmarksFilter == "missingLatLng" && landmark.irlAddress[0] != "?" && landmark.irlCoordinates[0] == 0 ||
                self.landmarksFilter == "included" && landmark.id[0] == "b" ||
                self.landmarksFilter == "notIncluded" && landmark.id[0] == "x"
            )
        })
        if (self.l && !self.currentLandmarks.map(function(landmark) {
            return landmark.id
        }).includes(self.l)) {
            self.l = null
        }
        self.clearMarkers()
        self.renderMarkers()
        self.sortLandmarks(self.landmarksSort) // update indexById 
        self.renderList()
        self.selectLandmark(self.l) // scroll into view
        self.renderStatus()
        self.renderItem()
    }

    self.formatAddress = function(address) {
        address = address || "?"
        if (!"0123456789?".includes(address[0])) {
            const parts = address.split(", ")
            const comma = parts.length == 1 ? "" : ", "
            return `<span style="font-weight: bold">${parts[0]}</span>${comma}${parts.slice(1).join(", ")}`
        }
        return address
    }

    self.formatCoordinates = function(coordinates) {
        if (coordinates[0] == 0 && coordinates[1] == 0) {
            return "?"
        }
        return coordinates.join(",")
    }

    self.formatDate = function(timestamp) {
        return new Date(timestamp * 1000).toISOString().slice(0, -5).replace("T", " ")
    }

    self.getHash = function() {
        return window.location.hash.slice(1).split(",").slice(0, 3).map(parseFloat)
    }

    self.getLandmarkNameAndAddress = function(address) {
        const parts = address.split(", ")
        if ("0123456789".includes(address[0])) {
            return [parts[0], address]
        }
        return [parts[0], parts.slice(1).join(", ")]
    }

    self.getLandmarkTitle = function(landmark) {
        return landmark.igAddress.split(", ")[0] + "\n" + landmark.irlAddress.split(", ")[0]
    }

    self.getMppx = function(z=self.z) {
        return self.mapW / (self.tileSize * Math.pow(2, z))
    }

    self.getSortString = function(address) {
        let parts = address.replace("?", "ZZZ").split(", ")
        parts.forEach(function(part, p) {
            let words = part.split(" ")
            words.forEach(function(word, w) {
                if (/^\d+$/.test(word)) {
                    words[w] = "0".repeat(10 - word.length) + word
                }
            })
            if (/^\d+$/.test(words[0])) {
                words = words.slice(1).concat(words[0])
            }
            parts[p] = words.join(" ")
        })
        return parts.reverse().join(", ")
    }

    self.loadJSON = async function(url) {
        try {
            const req = await fetch(url, {cache: "no-cache"})
            if (!req.ok) {
                throw new Error(req.status)
            }
            return await req.json()
        } catch (err) {
            throw err
        }
    }

    self.onHashchange = function(e) {
        let values = self.getHash()
        if (values.length == 1) {
            values = [self.defaultX, self.defaultY, values[0]]
        } else if (values.length == 2) {
            values = [values[0], values[1], self.defaultZ]
        }
        const hash = values.map(function(v, i) {
            const defaultV = [self.defaultX, self.defaultY, self.defaultZ][i]
            const minV = [self.minX, self.minY, self.minZ][i]
            const maxV = [self.maxX, self.maxY, self.maxZ][i]
            v = isNaN(v) ? defaultV : self.clamp(v, minV, maxV)
            return v.toFixed(3)
        }).join(",")
        if (hash != window.location.hash.substr(1)) {
            window.location.hash = hash
            return
        }
        [self.hashX, self.hashY, self.hashZ] = values
        if (!self.isAnimating) {
            self.animate()
        }
        //that.update.apply(null, values)
    }

    self.onKeydown = function(e) {
        const activeElement = document.activeElement
        if (activeElement.tagName == "INPUT") {
            return
        }
        if (self.focus == "dialog" && e.key == "Escape") {
            self.closePhotoDialog()
        }
        if (self.focus != "map") {
            return
        }
        console.log(e.key)
        if (["1", "2", "3", "4", "5", "6"].includes(e.key)) {
            self.setHash(self.hashX, self.hashY, parseInt(e.key))
        }
        if (["-", "=", "ArrowDown", "ArrowLeft", "ArrowRight", "ArrowUp"].includes(e.key)) {
            if (self.keydownTimeout) {
                clearTimeout(self.keydownTimeout)
                self.keydownTimeout = null
            }
            (function keydownFn() {
                if (e.key == "-") {
                    self.setHash(self.hashX, self.hashY, self.hashZ - self.zoomAmount)
                } else if (e.key == "=") {
                    self.setHash(self.hashX, self.hashY, self.hashZ + self.zoomAmount)
                } else if (e.key == "ArrowDown") {
                    self.setHash(self.hashX, self.hashY - self.getMppx() * canvas.height * self.panAmount, self.hashZ)
                } else if (e.key == "ArrowLeft") {
                    self.setHash(self.hashX - self.getMppx() * canvas.height * self.panAmount, self.hashY, self.hashZ)
                } else if (e.key == "ArrowRight") {
                    self.setHash(self.hashX + self.getMppx() * canvas.height * self.panAmount, self.hashY, self.hashZ)
                } else if (e.key == "ArrowUp") {
                    self.setHash(self.hashX, self.hashY + self.getMppx() * canvas.height * self.panAmount, self.hashZ)
                }
                self.keydownTimeout = setTimeout(keydownFn)
            }())
        }
        if (e.key == "Escape") {
            self.selectLandmark(null)
        }
    }

    self.onKeyup = function(e) {
        const activeElement = document.activeElement
        if (activeElement.tagName == "INPUT") {
            return
        }
        if (self.keydownTimeout) {
            clearTimeout(self.keydownTimeout)
            self.keydownTimeout = null
        }
    }

    self.onMousedown = function(e) {
        e.preventDefault()
        self.focus = "map"
        if (e.target.classList.contains("marker")) {
            const id = e.target.id.replace("marker_", "")
            if (e.target.classList.contains("selected") && e.metaKey) {
                self.selectLandmark(null)
            } else if (!e.target.classList.contains("selected")) {
                self.selectLandmark(id)
            }
            return
        }
        self.isDragging = false
        const clientX = e.clientX
        const clientY = e.clientY
        const [originalX, originalY, originalZ] = [self.hashX, self.hashY, self.hashZ]
        const mppx = self.getMppx()
        function onMousemove(e) {
            if (!self.isDragging) {
                self.isDragging = true
                self.element.classList.add("dragging")
            }
            self.setHash(
                originalX - mppx * (e.clientX - clientX),
                originalY + mppx * (e.clientY - clientY),
                originalZ,
                true
            )
        }
        function onMouseup(e) {
            if (self.mouseTimeout) {
                clearTimeout(self.mouseTimeout)
                self.mouseTimeout = null
                //console.log("click", "animating?", self.isAnimating)
                const x = originalX + mppx * (clientX - canvas.width / 2)
                const y = originalY - mppx * (clientY - canvas.height / 2)
                self.setHash(x, y, originalZ)
                navigator.clipboard.writeText(Math.round(x) + "," + Math.round(y))
            } else if (self.isDragging) {
                self.isDragging = false
                self.element.classList.remove("dragging")
                self.setHashURL()
            }
            document.removeEventListener("mousemove", onMousemove)
            document.removeEventListener("mouseup", onMouseup)
        }
        self.mouseTimeout = setTimeout(function() {
            document.addEventListener("mousemove", onMousemove)
            self.mouseTimeout = null
        }, 250)
        document.addEventListener("mouseup", onMouseup)
    }

    self.onResize = function(render=true) {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
        canvas.style.width = window.innerWidth + "px"
        canvas.style.height = window.innerHeight + "px"
        if (render) {
            self.renderMap()
        }
    }

    self.onWheel = function(e) {
        e.preventDefault()
        if (self.wheelTimeout) {
            clearTimeout(self.wheelTimeout)
            self.wheelTimeout = null
        }
        const targetZ = self.clamp(self.z - e.deltaY * self.wheelAmount, self.minZ, self.maxZ)
        const mppx = self.getMppx()
        const targetMppx = self.getMppx(targetZ)
        const offsetX = e.clientX - canvas.width / 2
        const offsetY = e.clientY - canvas.height / 2
        self.setHash(
            self.x + mppx * offsetX - targetMppx * offsetX,
            self.y - mppx * offsetY + targetMppx * offsetY,
            targetZ,
            true
        )
        self.wheelTimeout = setTimeout(function() {
            self.setHashURL()
        }, 100)
    }

    self.openPhotoDialog = function(landmark, source) {
        let img = document.createElement("img")
        img.src = `photos/${landmark.id},${source}.jpg`
        img.style.width = "1024px"
        img.style.height = "576px"
        self.photoDialogTitle.innerHTML = source == "ig" ? landmark.igAddress : landmark.irlAddress
        self.photoDialogContent.innerHTML = ""
        self.photoDialogContent.appendChild(img)
        self.dialogLayer.style.display = "flex"
        self.focus = "dialog"
    }

    self.closePhotoDialog = function() {
        self.dialogLayer.style.display = "none"
        self.focus = "item"
    }

    self.panToLandmark = function() {
        const landmark = self.landmarksById[self.l]
        self.setHash(landmark.igCoordinates[0], landmark.igCoordinates[1], self.z)
    }

    self.renderItem = function() {
        if (self.l) {
            landmark = self.landmarksById[self.l]
            self.itemId.innerHTML = landmark.id.toUpperCase()
            self.itemIg.style.borderRightColor = "#" + landmark.color
            self.itemIgName.innerHTML = landmark.igNameAndAddress[0]
            self.itemIgAddress.innerHTML = landmark.igNameAndAddress[1]
            self.itemIgCoordinates.innerHTML = '<a href="#'
                    + landmark.igCoordinates.join(",") + ',5.000">'
                    + landmark.igCoordinates.join(",") + "</a>"
            self.itemIrl.style.borderRightColor = "#" + landmark.color
            self.itemIrlName.innerHTML = landmark.irlNameAndAddress[0]
            self.itemIrlAddress.innerHTML = landmark.irlNameAndAddress[1]
            self.itemIrlCoordinates.innerHTML = landmark.irlCoordinates[0] == 0 ? "?"
                    : '<a href="https://google.com/maps/search/'
                    + encodeURIComponent(landmark.irlAddress)
                    + '" target="_blank">' + landmark.irlCoordinates.join(",") + "</a>"
            self.itemEdited.innerHTML = "LAST EDITED: " + self.formatDate(landmark.edited) + " UTC"
            if (landmark.id == "b315") {
                self.itemIgPhoto.innerHTML = ""
                let img = document.createElement("img")
                img.src = "photos/b315,ig.jpg"
                img.style.width = "256px"
                img.style.height = "144px"
                img.addEventListener("click", function() {
                    self.openPhotoDialog(landmark, "ig")
                })
                self.itemIgPhoto.appendChild(img)
                self.itemIrlPhoto.innerHTML = ""
                img = document.createElement("img")
                img.src = "photos/b315,irl.jpg"
                img.style.width = "256px"
                img.style.height = "144px"
                img.addEventListener("click", function() {
                    self.openPhotoDialog(landmark, "irl")
                })
                self.itemIrlPhoto.appendChild(img)
            } else {
                self.itemIgPhoto.innerHTML = ""
                self.itemIrlPhoto.innerHTML = ""
            }
            self.itemPanel.style.display = "block"
        } else {
            self.itemPanel.style.display = "none"
        }
    }

    self.renderList = function() {
        self.listBody.innerHTML = ""
        self.currentLandmarks.forEach(function(landmark) {
            const itemElement = document.createElement("div")
            itemElement.classList.add("item")
            if (landmark.id == self.l) {
                itemElement.classList.add("selected")
            }
            itemElement.id = "item_" + landmark.id
            itemElement.style.borderLeftColor = "#" + landmark.color
            const igElement = document.createElement("div")
            igElement.className = "ig"
            igElement.innerHTML = self.landmarksSort.includes("Address") ? landmark.igAddress
                    : landmark.igAddress + " &nbsp;|&nbsp; " + landmark.irlAddress
            itemElement.appendChild(igElement)
            const irlElement = document.createElement("div")
            irlElement.className = "irl"
            irlElement.innerHTML = self.landmarksSort.includes("Address") ? landmark.irlAddress
                    : self.landmarksSort.includes("igL") ? self.formatCoordinates(landmark.igCoordinates)
                    : self.landmarksSort.includes("irlL") ? self.formatCoordinates(landmark.irlCoordinates)
                    : self.landmarksSort == "type" ? landmark.type.toUpperCase()
                    : self.formatDate(landmark.edited)
            itemElement.appendChild(irlElement)
            self.listBody.appendChild(itemElement)
        })
    }

    self.renderMap = function() {

        const zInt = Math.ceil(self.z)
        const mapSize = self.tileSize * Math.pow(2, self.z)
        const mppx = mapSize / self.mapW
        const cX = (self.x + self.zeroX) * mppx
        const cY = (self.zeroY - self.y) * mppx
        const offsetX = self.canvas.width / 2 - cX;
        const offsetY = self.canvas.height / 2 - cY;
        const tileSize = self.tileSize * Math.pow(2, self.z - zInt);

        const [[x0, y0], [x1, y1]] = self.tileRanges[zInt]
        const minTx = self.clamp(Math.floor(-offsetX / tileSize), x0, x1)
        const maxTx = self.clamp(Math.ceil((self.canvas.width - offsetX) / tileSize), x0, x1)
        const minTy = self.clamp(Math.floor(-offsetY / tileSize), y0, y1)
        const maxTy = self.clamp(Math.ceil((self.canvas.height - offsetY) / tileSize), y0, y1)

        for (let y = minTy; y <= maxTy; y++) {
            for (let x = minTx; x <= maxTx; x++) {
                const img = self.tiles[zInt][y][x];
                if (!img.src) {
                    img.onload = self.render
                    img.src = `tiles/${zInt}/${zInt},${y},${x}.png`;
                }
                if (img.naturalWidth) {
                    self.context.drawImage(
                        img,
                        offsetX + x * tileSize,
                        offsetY + y * tileSize,
                        tileSize,
                        tileSize
                    )
                }
            }
        }
        self.renderMarkers()

    }

    self.clearMarkers = function() {
        self.landmarks.forEach(function(landmark) {
            if (!self.currentLandmarks.includes(landmark)) {
                let marker = self.markers[landmark.id]
                marker.classList.remove("selected")
                marker.style.display = "none"
            }
        })
    }

    self.renderMarkers = function() {
        const mppx = self.getMppx()
        const minX = self.x - mppx * self.canvas.width / 2
        const maxX = self.x + mppx * self.canvas.width / 2
        const minY = self.y - mppx * self.canvas.height / 2
        const maxY = self.y + mppx * self.canvas.height / 2
        self.currentLandmarks.forEach(function(landmark) {
            let markerElement = self.markers[landmark.id]
            const [x, y] = landmark.igCoordinates
            if (x >= minX - 16 && x <= maxX + 16 && y >= minY -16 && y <= maxY + 16) {
                markerElement.style.left = (x - minX) / mppx + "px"
                markerElement.style.top = (maxY - y) / mppx + "px"
                markerElement.style.display = "block"
            } else {
                markerElement.style.display = "none"
            }
        })
    }

    self.renderStatus = function() {
        self.statusBar.innerHTML = self.currentLandmarks.length + " LANDMARK" + (
            self.currentLandmarks.length == 1 ? "" : "S"
        )
    }

    self.selectLandmark = function(id) {
        self.l = id
        let element = document.querySelector(".marker.selected")
        if (element) {
            element.classList.remove("selected")
        }
        if (self.l) {
            element = document.querySelector("#marker_" + self.l)
            if (element) {
                element.classList.add("selected")
            }
        }
        element = document.querySelector(".item.selected")
        if (element) {
            element.classList.remove("selected")
        }
        if (self.l) {
            element = document.querySelector("#item_" + self.l)
            if (element) {
                element.classList.add("selected")
                const top = 96, bottom = window.innerHeight - 64
                const y = element.getBoundingClientRect().y
                if (y < top) {
                    self.listBody.scrollTo(0, self.listBody.scrollTop + y - top)
                } else if (y > bottom) {
                    self.listBody.scrollTo (0, self.listBody.scrollTop + y - bottom)
                }
            }
        }
        self.renderItem()
    }

    self.setHash = function(x, y, z, immediate=false) {
        x = self.clamp(x, self.minX, self.maxX)
        y = self.clamp(y, self.minY, self.maxY)
        z = self.clamp(z, self.minZ, self.maxZ)
        if (x != self.hashX || y != self.hashY || z != self.hashZ) {
            self.hashX = x
            self.hashY = y
            self.hashZ = z
            if (!self.isAnimating || immediate) {
                self.animate(immediate)
            }
        }

    }

    self.setHashURL = function() {
        const hash = [self.hashX, self.hashY, self.hashZ].map(function (v) {
            return v.toFixed(3)
        }).join(',')
        if (window.location.hash.slice(1) != hash) {
            // history.replaceState(null, "", "#" + hash)
            window.location.hash = hash
        }
    }

    self.sortLandmarks = function(option) {
        self.landmarksSort = option
        self.currentLandmarks.sort(function(a, b) {
            let sortValues = [a, b].map(function(v) {
                if (self.landmarksSort == "igAddress") {
                    return self.getSortString(v.igAddress) + ", " + self.getSortString(v.irlAddress)
                } else if (self.landmarksSort == "igLatitude") {
                    return -v.igCoordinates[1] || 1000
                } else if (self.landmarksSort == "igLongitude") {
                    return v.igCoordinates[0] || 1000
                } else if (self.landmarksSort == "irlAddress") {
                    return self.getSortString(v.irlAddress) + ", " + self.getSortString(v.igAddress)
                } else if (self.landmarksSort == "irlLatitude") {
                    return -v.irlCoordinates[0] || 1000
                } else if (self.landmarksSort == "irlLongitude") {
                    return v.irlCoordinates[1] || 1000
                } else if (self.landmarksSort == "type") {
                    return [v.type].concat(v.igAddress.split(", ").reverse()).join(", ")   
                } else if (self.landmarksSort == "edited") {
                    return -v.edited
                }
            })
            return sortValues[0] < sortValues[1] ? -1 : sortValues[0] > sortValues[1] ? 1 : 0
        })
        self.currentLandmarkIndexById = self.currentLandmarks.reduce(function(a, v, i) {
            a[v.id] = i
            return a
        }, {})
    }

    return self.init()

}

const map = Map()

        </script>
    </body>
</html>